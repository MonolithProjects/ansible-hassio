---

- name: Run Hass.io
  docker_container:
    name: hassio_supervisor
    image: "{{ supervisor }}:{{ version }}"
    state: started
    privileged: "{{ privileged_mode }}"
    restart: no
    restart_policy: unless-stopped
    env:
      SUPERVISOR_SHARE: "{{ supervisor_share }}"
      SUPERVISOR_NAME: hassio_supervisor
      HOMEASSISTANT_REPOSITORY: homeassistant/qemux86-homeassistant
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/run/dbus:/var/run/dbus
      - "{{ supervisor_share }}:/data"
    comparisons:
      image: ignore
      env: strict
      volumes: allow_more_present
    security_opts:
      - seccomp:unconfined
      - apparmor:unconfined

- name: Install AppArmor scripts
  ansible.builtin.template:
    src: hassio-apparmor.j2
    dest: /usr/sbin/hassio-apparmor

- name: Install AppArmor Service
  ansible.builtin.template:
    src: hassio-apparmor.service.j2
    dest: /etc/systemd/system/hassio-apparmor.service
  notify: Restart hassio-apparmor

- name: Copy hassio supervisor
  ansible.builtin.template:
    src: hassio-supervisor.j2
    dest: /usr/sbin/hassio-supervisor

- name: Copy HASSIO Service
  ansible.builtin.template:
    src: hassio-supervisor.service.j2
    dest: /etc/systemd/system/hassio-supervisor.service
  notify: Restart hassio-supervisor

- name: Install the 'ha' cli
  ansible.builtin.copy:
    src: ha
    dest: /usr/sbin/ha
    mode: '0755'
